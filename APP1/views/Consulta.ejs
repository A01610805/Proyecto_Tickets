<%- include('includes/head.ejs') %>

<% var i=1; 
var titulo='';

if(tipo==1){
titulo='Consulta de tickets activos';
}
else if(tipo==2){
  titulo='Consulta de tickets archivados';
  }
else if(tipo==3){
titulo='Consulta de tickets propios';
} %>

<h1><%=titulo %></h1>

<% for (let ticket of tickets) {
  var color ='';
 if(ticket.ID_estado == 1){
  color = 'grey lighten-5';
 }
 else if(ticket.ID_estado == 2){
  color = 'light-blue lighten-5';
 }
 else if(ticket.ID_estado == 3){
  color = 'orange lighten-5';
 }
 else if(ticket.ID_estado == 4){
  color = 'yellow light-blue lighten-5';
 }
 else if(ticket.ID_estado == 5){
  color = 'red lighten-1';
 }
 else if(ticket.ID_estado == 6){
  color = 'light-green accent-1';
 }

%>

<label for="buscar_creador">Buscar por nombre del creador: </label>
<input type="text" name="buscar_creador" id="buscar_creador">

<div class="row" id="respuesta_ajax">
  <div class="row">
    <div class="col s12 m12 l6">
          <div class="card">
              <div class="card-content">
                <h3><%=ticket.titulo %></h3>
              </div>

              <div class="card-tabs">
                <ul class="tabs tabs-fixed-width">
                  <li class="tab"><a class="active" href="#descripcion/<%=i%>">Descripción</a></li>
                  <li class="tab"><a href="#p&r<%=i%>">Preguntas y Respuestas</a></li>
                  <li class="tab"><a href="#datosgenerales<%=i%>">Datos Generales</a></li>
                  <li class="tab"><a href="#comentarios<%=i%>">Comentarios</a></li>
                </ul>
              </div>
              
              <div class="card-content <%=color %>">
                <div id="#descripcion/<%= i%>">

                </div>
                <div id="#p&r<%=i%>">
                  <h5>Nombre del Creador: <%=ticket.Nombre_creador%> <%=ticket.Apellido_P_creador%> <%=ticket.Apellido_M_creador%></h5>
                  <h5>Nombre del Encargado: <%=ticket.Nombre_encargado%> <%=ticket.Apellido_P_encargado%> <%=ticket.Apellido_M_encargado%></h5>
                  <%if((rol!=3 || tipo==3) && ticket.ID_estado!=5 && ticket.ID_estado!=6){
                    var ruta='';
                    if(tipo==3){
                      ruta='propio';
                    }
                    else if(tipo==2){
                      ruta='archivo';
                    }
                    else if(tipo==1){
                      ruta='activos';
                    }
                    
                    %>
                    
                    <form action="/buscar_tickets/<%=ruta%>" method="POST">
                      <input for="idticket" id="idticket" name="idticket" type="hidden" value="<%=ticket.ID_ticket%>"/>
                      <button class="btn waves-effect waves-light" type="submit" name="action">Cancelar ticket
                        <i class="material-icons highlight_off">send</i>
                    </button>
                  </form>
                    <%}%>
                </div>
                <div id="#datosgenerales<%=i%>">
                </div>
                <div id="#comentarios<%=i%>">
                </div>
              </div>
          </div>
      </div>
  </div>
</div>

<script>
  const accion_asincrona = () => {
      const valor_busqueda = document.getElementById('buscar').value;
      console.log(valor_busqueda);

      //El token de protección CSRF
      //const csrf = document.getElementById('_csrf').value;

      //función que manda la petición asíncrona
      fetch('/capybaras/buscar/'+valor_busqueda, {
          method: 'GET',
          headers: {
              'Content-Type': 'application/json',
              //'csrf-token': csrf
          }
          //body: JSON.stringify(data)
      }).then(result => {
          return result.json(); //Regresa otra promesa
      }).then(data => {
          //Modificamos el DOM de nuestra página de acuerdo a los datos de la segunda promesa
          console.log(data);
          let respuesta = '';
          respuesta = '<div class="row">'+
            '<div class="col s12 m12 l6">' +
                  '<div class="card">'+
                      '<div class="card-content">'+
                        '<h3>'+ticket.titulo+'</h3>'+
                      '</div>'+
                      '<div class="card-tabs">'+
                        '<ul class="tabs tabs-fixed-width">'+
                         ' <li class="tab"><a class="active" href="#descripcion/<%=i%>">Descripción</a></li>'+
                          '<li class="tab"><a href="#p&r<%=i%>">Preguntas y Respuestas</a></li>'+
                          '<li class="tab"><a href="#datosgenerales<%=i%>">Datos Generales</a></li>'+
                         ' <li class="tab"><a href="#comentarios<%=i%>">Comentarios</a></li>'+
                        '</ul>'+
                      '</div>'+
                      '<div class="card-content <%=color %>">'+
                        '<div id="#descripcion/<%= i%>">'+
                        '</div>'+
                        '<div id="#p&r<%=i%>">'+
                          '<h5>Nombre del Creador: '+ ticket.Nombre_creador + ticket.Apellido_P_creador + ticket.Apellido_M_creador + '</h5>'+
                          '<h5>Nombre del Encargado: ' + ticket.Nombre_encargado + ticket.Apellido_P_encargado + ticket.Apellido_M_encargado + '</h5>' + 
                          '<%if((rol!=3 || tipo==3) && ' + ticket.ID_estado + '!=5 && ' + ticket.ID_estado + ' + !=6){' +
                            "var ruta='';"+
                            'if(tipo==3){'+
                              "ruta='propio';"+
                            '}'+
                            'else if(tipo==2){'+
                              "ruta='archivo';"+
                            '}'+
                            'else if(tipo==1){'+
                              "ruta='activos';"+
                            '}'+
                            '%>'+
                            '<form action="/buscar_tickets/<%=ruta%>" method="POST">'+
                              '<input for="idticket" id="idticket" name="idticket" type="hidden" value="' + ticket.ID_ticket  + '"/>' +
                              '<button class="btn waves-effect waves-light" type="submit" name="action">Cancelar ticket' + 
                               ' <i class="material-icons highlight_off">send</i>'+
                            '</button>'+
                          '</form>' + 
                            '<%}%>' + 
                        '</div>' + 
                        '<div id="#datosgenerales' + i + '">' + 
                        '</div>' + 
                        '<div id="#comentarios'+i+'">'+
                        '</div>'+
                      '</div>'+
                  '</div>' + 
              '</div>' + 
          '</div>';

          document.getElementById('respuesta_ajax').innerHTML = respuesta;
          
      }).catch(err => {
          console.log(err);
      });
  };

  document.getElementById('buscar').onkeyup = accion_asincrona;
</script>

<% i=i+1;} %>


<%- include('includes/footer.ejs') %>