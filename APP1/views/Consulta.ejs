<%- include('includes/head.ejs') %>

<% var i=1; 
var titulo='';
if(tipo==1){
titulo='Consulta de tickets activos';
}
else if(tipo==2){
  titulo='Consulta de tickets archivados';
}
else if(tipo==3){
  titulo='Consulta de tickets propios';
} %>

<h1><%=titulo %></h1>

<% if (tipo==1){ %>
  <nav class="grey darken-3">
    <div class="nav-wrapper">
      <ul class="left hide-on-med-and-down">
        <div class="right input-field col s4">
          <label for="buscar_encargado_1">Encargado: </label>
          <input type="text" name="buscar_encargado_1" id="buscar_encargado_1">
        </div>
        <div class="right input-field col s4">
          <label for="buscar_creador_1">Creador: </label>
          <input type="text" name="buscar_creador_1" id="buscar_creador_1">
        </div>
        <div class="right input-field col s4">
          <label for="titulo">Filtrar por: </label>
          <input disabled value = '' type="text" name="titulo" id="titulo">
        </div>
      </ul>
    </div>
  </nav>
<% } else if (tipo == 2) { %>
    <nav class="grey darken-3">
      <div class="nav-wrapper">
        <ul class="left hide-on-med-and-down">
          <div class="right input-field col s4">
            <label for="buscar_encargado_2">Encargado: </label>
            <input type="text" name="buscar_encargado_2" id="buscar_encargado_2">
          </div>
          <div class="right input-field col s4">
            <label for="buscar_creador_2">Creador: </label>
            <input type="text" name="buscar_creador_2" id="buscar_creador_2">
          </div>
          <div class="right input-field col s4">
            <label for="titulo">Filtrar por: </label>
            <input disabled value = '' type="text" name="titulo" id="titulo">
          </div>
        </ul>
      </div>
    </nav>
<% } else { %>
  <nav class="grey darken-3">
    <div class="nav-wrapper">
      <ul class="left hide-on-med-and-down">
        <div class="right input-field col s4">
          <label for="buscar_titulo">Titulo: </label>
          <input type="text" name="buscar_titulo" id="buscar_titulo">
        </div>
        <div class="right input-field col s4">
          <label for="titulo">Filtrar por: </label>
          <input disabled value = '' type="text" name="titulo" id="titulo">
        </div>
      </ul>
    </div>
  </nav>
<% } %>

<div class="row" id="respuesta_ajax">

  <% for (let ticket of tickets) {
    var color ='';
  if(ticket.ID_estado == 1){
    color = 'grey lighten-5';
  }
  else if(ticket.ID_estado == 2){
    color = 'light-blue lighten-5';
  }
  else if(ticket.ID_estado == 3){
    color = 'orange lighten-5';
  }
  else if(ticket.ID_estado == 4){
    color = 'yellow light-blue lighten-5';
  }
  else if(ticket.ID_estado == 5){
    color = 'red lighten-1';
  }
  else if(ticket.ID_estado == 6){
    color = 'light-green accent-1';
  } 
  %>

  <div class="row">
    <div class="col l6 m4 m2">
      <div class="card">
        <div class="card-content">
          <h3><%=ticket.titulo %></h3>
        </div>

        <div class="card-tabs">
          <ul class="tabs tabs-fixed-width">
            <li class="tab"><a class="active" href="#descripcion/<%=i+1%>">Descripción</a></li>
            <li class="tab"><a href="#p&r<%=i+2%>">Preguntas y Respuestas</a></li>
            <li class="tab"><a href="#datosgenerales/<%=i+3%>">Datos Generales</a></li>
            <li class="tab"><a href="#comentarios/<%=i+4%>">Comentarios</a></li>
          </ul>
        </div>
              
        <div class="card-content <%=color %>">
          <div id="#descripcion/<%= i+1%>"> 
          </div>
          <div id="#p&r/<%=i+2%>">
            <h5>Nombre del Creador: <%=ticket.Nombre_creador%> <%=ticket.apellido_P_creador%> <%=ticket.Apellido_M_creador%></h5>
            <h5>Nombre del Encargado: <%=ticket.Nombre_encargado%> <%=ticket.Apellido_P_encargado%> <%=ticket.Apellido_M_encargado%></h5>
            <%if((rol != 3 || tipo == 3) && ticket.ID_estado != 5 && ticket.ID_estado !=6 ){
            var ruta='';
            if(tipo==3){
              ruta='propio';
            }
            else if(tipo==2){
              ruta='archivo';
            }
            else if(tipo==1){
              ruta='activos';
            }
            %>
            <form action="/buscar_tickets/<%=ruta%>" method="POST">
              <input for="idticket" id="idticket" name="idticket" type="hidden" value="<%=ticket.ID_ticket%>"/>
              <button class="btn waves-effect waves-light" type="submit" name="action">Cancelar ticket
                <i class="material-icons highlight_off">Send</i>
              </button>
            </form>
            <%}%>
          </div>

          <div id="#datosgenerales/<%=i+3%>">
          </div>
          <div id="#comentarios/<%=i+4%>">
          </div>

        </div>
      </div>
    </div>
  </div>
  <% i=i+4;%>
  <% } %>
  <div class="col l6 m4 s2">
    <ul class="pagination center-align">
      <% for (let i = 1; i <= Math.ceil(total_tickets/2); i++) { %>
        <li class="active"><a href="/buscar_tickets/start<%= tipo %>/<%= (i-1)*2 %>"><%= i %></a></li>
      <% } %>
    </ul>
  </div>
</div>


<script>

  const activos = () => {
      var str1,str2,
      bc1 = document.getElementById('buscar_creador_1');
      be1 = document.getElementById('buscar_encargado_1');
      if (bc1 != null || be1 != null) {
          str1 = bc1.value;
          str2 = be1.value;
      }
      else {
          str1 = null;
          str2 = null;
      }
      const valor_busqueda = str1+'&'+str2;
      //El token de protección CSRF
      //const csrf = document.getElementById('_csrf').value;
      //función que manda la petición asíncrona
      fetch('/buscar_tickets/activos/'+ valor_busqueda, {
          method: 'GET',
          headers: {
              'Content-Type': 'application/json',
              //'csrf-token': csrf
          }
          //body: JSON.stringify(data)
      }).then(result => {
          return result.json(); //Regresa otra promesa
      }).then(data => {
          //Modificamos el DOM de nuestra página de acuerdo a los datos de la segunda promesa
          console.log(data);
          let respuesta = '';
          let i=1;
          let rol = 1;
          let tipo = 1;
          for (let ticket of data) {
              var color ='';
            if(ticket.ID_estado == 1){
              color = 'grey lighten-5';
            }
            else if(ticket.ID_estado == 2){
              color = 'light-blue lighten-5';
            }
            else if(ticket.ID_estado == 3){
              color = 'orange lighten-5'
            }
            else if(ticket.ID_estado == 4){
              color = 'yellow light-blue lighten-5';
            }
            else if(ticket.ID_estado == 5){
              color = 'red lighten-1';
            }
            else if(ticket.ID_estado == 6){
              color = 'light-green accent-1';
            } 
            respuesta += '<div class="row">'+
              '<div class="col l6 m4 m2">'+
                '<div class="card">'+
                  '<div class="card-content">'+
                    '<h3>'+ticket.titulo+'</h3>'+
                  '</div>'+
                  '<div class="card-tabs">' +
                    '<ul class="tabs tabs-fixed-width">'+
                      '<li class="tab"><a class="active" href="#descripcion/'+i+1+'">Descripción</a></li>'+
                      '<li class="tab"><a href="#p&r'+i+2+'">Preguntas y Respuestas</a></li>'+
                      '<li class="tab"><a href="#datosgenerales/'+i+3+'">Datos Generales</a></li>'+
                      '<li class="tab"><a href="#comentarios/'+i+4+'">Comentarios</a></li>'+
                    '</ul>'+
                  '</div>'+
                        
                  '<div class="card-content '+color+'">'+
                    '<div id="#descripcion/'+i+1+'">'+ 
                    '</div>'+
                    '<div id="#p&r/'+i+2+'">'+
                      '<h5>Nombre del Creador: '+ticket.Nombre_creador+' '+ticket.apellido_P_creador+' '+ticket.Apellido_M_creador+'</h5>'+
                      '<h5>Nombre del Encargado: '+ticket.Nombre_encargado+' '+ticket.Apellido_P_encargado+' '+ticket.Apellido_M_encargado+'</h5>';
                      if((rol != 3 || tipo == 3) && ticket.ID_estado != 5 && ticket.ID_estado !=6 ){
                      var ruta='';
                      if(tipo==3){
                        ruta='propio';
                      }
                      else if(tipo==2){
                        ruta='archivo';
                      }
                      else if(tipo==1){
                        ruta='activos';
                      }
                      respuesta += '<form action="/buscar_tickets/'+ruta+'" method="POST">'+
                        '<input for="idticket" id="idticket" name="idticket" type="hidden" value="'+ticket.ID_ticket+'"/>'+
                        '<button class="btn waves-effect waves-light" type="submit" name="action">Cancelar ticket' + 
                          '<i class="material-icons highlight_off">Send</i>'+
                        '</button>'+
                      '</form>';
                      }
                    respuesta += '</div>'+

                    '<div id="#datosgenerales/'+i+3+'">'+
                    '</div>'+
                    '<div id="#comentarios/'+i+4+'">'+
                    '</div>'+

                  '</div>'+
                '</div>'+
              '</div>'+
            '</div>';
            }
            respuesta += '<div class="col l6 m4 s2">'+
              '<ul class="pagination center-align">';
                for (let i = 1; i <= Math.ceil(Object.keys(data)/2); i++) {
                  respuesta += '<li class="active"><a href="/buscar_tickets/start1/("'+i+'"-1)*2">+'+i+'+</a></li>';
                }
              respuesta+='</ul>'+
            '</div>';
              
        document.getElementById('respuesta_ajax').innerHTML = respuesta;
        
      }).catch(err => {
        console.log('Error de ajax');
        console.log(err);
      });
  };

  bc1 = document.getElementById('buscar_creador_1');
  be1 = document.getElementById('buscar_encargado_1');

  if (bc1 != null || be1 != null) {
    document.getElementById('buscar_creador_1').onkeyup = activos;
    document.getElementById('buscar_encargado_1').onkeyup = activos;
  }

  const archivados = () => {
    var str1,str2,
    bc2 = document.getElementById('buscar_creador_2');
    be2 = document.getElementById('buscar_encargado_2');
    if (bc2 != null || be2 != null) {
      str1 = bc2.value;
      str2 = be2.value;
    }
    else {
        str1 = null;
        str2 = null;
    }
      const valor_busqueda = str1+'&'+str2;
      //El token de protección CSRF
      //const csrf = document.getElementById('_csrf').value;
      //función que manda la petición asíncrona
      fetch('/buscar_tickets/archivo/'+ valor_busqueda, {
          method: 'GET',
          headers: {
              'Content-Type': 'application/json',
              //'csrf-token': csrf
          }
          //body: JSON.stringify(data)
      }).then(result => {
          return result.json(); //Regresa otra promesa
      }).then(data => {
          //Modificamos el DOM de nuestra página de acuerdo a los datos de la segunda promesa
          console.log(data);
          let respuesta = '';
          let i=1;
          let rol = 1;
          let tipo = 2;
          for (let ticket of data) {
              var color ='';
            if(ticket.ID_estado == 1){
              color = 'grey lighten-5';
            }
            else if(ticket.ID_estado == 2){
              color = 'light-blue lighten-5';
            }
            else if(ticket.ID_estado == 3){
              color = 'orange lighten-5'
            }
            else if(ticket.ID_estado == 4){
              color = 'yellow light-blue lighten-5';
            }
            else if(ticket.ID_estado == 5){
              color = 'red lighten-1';
            }
            else if(ticket.ID_estado == 6){
              color = 'light-green accent-1';
            } 
            respuesta += '<div class="row">'+
              '<div class="col l6 m4 m2">'+
                '<div class="card">'+
                  '<div class="card-content">'+
                    '<h3>'+ticket.titulo+'</h3>'+
                  '</div>'+
                  '<div class="card-tabs">' +
                    '<ul class="tabs tabs-fixed-width">'+
                      '<li class="tab"><a class="active" href="#descripcion/'+i+1+'">Descripción</a></li>'+
                      '<li class="tab"><a href="#p&r'+i+2+'">Preguntas y Respuestas</a></li>'+
                      '<li class="tab"><a href="#datosgenerales/'+i+3+'">Datos Generales</a></li>'+
                      '<li class="tab"><a href="#comentarios/'+i+4+'">Comentarios</a></li>'+
                    '</ul>'+
                  '</div>'+
                        
                  '<div class="card-content '+color+'">'+
                    '<div id="#descripcion/'+i+1+'">'+ 
                    '</div>'+
                    '<div id="#p&r/'+i+2+'">'+
                      '<h5>Nombre del Creador: '+ticket.Nombre_creador+' '+ticket.apellido_P_creador+' '+ticket.Apellido_M_creador+'</h5>'+
                      '<h5>Nombre del Encargado: '+ticket.Nombre_encargado+' '+ticket.Apellido_P_encargado+' '+ticket.Apellido_M_encargado+'</h5>';
                      if((rol != 3 || tipo == 3) && ticket.ID_estado != 5 && ticket.ID_estado !=6 ){
                      var ruta='';
                      if(tipo==3){
                        ruta='propio';
                      }
                      else if(tipo==2){
                        ruta='archivo';
                      }
                      else if(tipo==1){
                        ruta='activos';
                      }
                      respuesta += '<form action="/buscar_tickets/'+ruta+'" method="POST">'+
                        '<input for="idticket" id="idticket" name="idticket" type="hidden" value="'+ticket.ID_ticket+'"/>'+
                        '<button class="btn waves-effect waves-light" type="submit" name="action">Cancelar ticket' + 
                          '<i class="material-icons highlight_off">Send</i>'+
                        '</button>'+
                      '</form>';
                      }
                    respuesta += '</div>'+

                    '<div id="#datosgenerales/'+i+3+'">'+
                    '</div>'+
                    '<div id="#comentarios/'+i+4+'">'+
                    '</div>'+

                  '</div>'+
                '</div>'+
              '</div>'+
            '</div>';
            }
            respuesta += '<div class="col l6 m4 s2">'+
              '<ul class="pagination center-align">';
                for (let i = 1; i <= Math.ceil(Object.keys(data)/2); i++) {
                  respuesta += '<li class="active"><a href="/buscar_tickets/start1/("'+i+'"-1)*2">+'+i+'+</a></li>';
                }
              respuesta+='</ul>'+
            '</div>';
              
        document.getElementById('respuesta_ajax').innerHTML = respuesta;
        
      }).catch(err => {
        console.log('Error de ajax');
        console.log(err);
      });
  };


  bc2 = document.getElementById('buscar_creador_2');
  be2 = document.getElementById('buscar_encargado_2');

  if (bc2 != null || be2 != null) {
    document.getElementById('buscar_creador_2').onkeyup = archivados;
    document.getElementById('buscar_encargado_2').onkeyup = archivados;
  }

  const propios = () => {
    var str1,
    bt = document.getElementById('buscar_titulo');
    if (bc2 != null) {
      str1 = bT.value;
    }
    else {
        str1 = null;
    }
      const valor_busqueda = (request.cookies.correo_usuario)+'&'+str1;
      //El token de protección CSRF
      //const csrf = document.getElementById('_csrf').value;
      //función que manda la petición asíncrona
      fetch('/buscar_tickets/propio/'+ valor_busqueda, {
          method: 'GET',
          headers: {
              'Content-Type': 'application/json',
              //'csrf-token': csrf
          }
          //body: JSON.stringify(data)
      }).then(result => {
          return result.json(); //Regresa otra promesa
      }).then(data => {
          //Modificamos el DOM de nuestra página de acuerdo a los datos de la segunda promesa
          console.log(data);
          let respuesta = '';
          let i=1;
          let rol = 1;
          let tipo = 3;
          for (let ticket of data) {
              var color ='';
            if(ticket.ID_estado == 1){
              color = 'grey lighten-5';
            }
            else if(ticket.ID_estado == 2){
              color = 'light-blue lighten-5';
            }
            else if(ticket.ID_estado == 3){
              color = 'orange lighten-5'
            }
            else if(ticket.ID_estado == 4){
              color = 'yellow light-blue lighten-5';
            }
            else if(ticket.ID_estado == 5){
              color = 'red lighten-1';
            }
            else if(ticket.ID_estado == 6){
              color = 'light-green accent-1';
            } 
            respuesta += '<div class="row">'+
              '<div class="col l6 m4 m2">'+
                '<div class="card">'+
                  '<div class="card-content">'+
                    '<h3>'+ticket.titulo+'</h3>'+
                  '</div>'+
                  '<div class="card-tabs">' +
                    '<ul class="tabs tabs-fixed-width">'+
                      '<li class="tab"><a class="active" href="#descripcion/'+i+1+'">Descripción</a></li>'+
                      '<li class="tab"><a href="#p&r'+i+2+'">Preguntas y Respuestas</a></li>'+
                      '<li class="tab"><a href="#datosgenerales/'+i+3+'">Datos Generales</a></li>'+
                      '<li class="tab"><a href="#comentarios/'+i+4+'">Comentarios</a></li>'+
                    '</ul>'+
                  '</div>'+
                        
                  '<div class="card-content '+color+'">'+
                    '<div id="#descripcion/'+i+1+'">'+ 
                    '</div>'+
                    '<div id="#p&r/'+i+2+'">'+
                      '<h5>Nombre del Creador: '+ticket.Nombre_creador+' '+ticket.apellido_P_creador+' '+ticket.Apellido_M_creador+'</h5>'+
                      '<h5>Nombre del Encargado: '+ticket.Nombre_encargado+' '+ticket.Apellido_P_encargado+' '+ticket.Apellido_M_encargado+'</h5>';
                      if((rol != 3 || tipo == 3) && ticket.ID_estado != 5 && ticket.ID_estado !=6 ){
                      var ruta='';
                      if(tipo==3){
                        ruta='propio';
                      }
                      else if(tipo==2){
                        ruta='archivo';
                      }
                      else if(tipo==1){
                        ruta='activos';
                      }
                      respuesta += '<form action="/buscar_tickets/'+ruta+'" method="POST">'+
                        '<input for="idticket" id="idticket" name="idticket" type="hidden" value="'+ticket.ID_ticket+'"/>'+
                        '<button class="btn waves-effect waves-light" type="submit" name="action">Cancelar ticket' + 
                          '<i class="material-icons highlight_off">Send</i>'+
                        '</button>'+
                      '</form>';
                      }
                    respuesta += '</div>'+

                    '<div id="#datosgenerales/'+i+3+'">'+
                    '</div>'+
                    '<div id="#comentarios/'+i+4+'">'+
                    '</div>'+

                  '</div>'+
                '</div>'+
              '</div>'+
            '</div>';
            }
            respuesta += '<div class="col l6 m4 s2">'+
              '<ul class="pagination center-align">';
                for (let i = 1; i <= Math.ceil(total_tickets/2); i++) {
                  respuesta += '<li class="active"><a href="/buscar_tickets/start1/("'+i+'"-1)*2">+'+i+'+</a></li>';
                }
              respuesta+='</ul>'+
            '</div>';
              
        document.getElementById('respuesta_ajax').innerHTML = respuesta;
        
      }).catch(err => {
        console.log('Error de ajax');
        console.log(err);
      });
  }; 

  bt = document.getElementById('buscar_titlo');

  if (bt != null) {
    document.getElementById('buscar_titulo').onkeyup = propios;
  }

</script>

<%- include('includes/footer.ejs') %>

